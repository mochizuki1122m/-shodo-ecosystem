.PHONY: help setup build up down logs clean test

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "Shodo Ecosystem - Makefile Commands"
	@echo ""
	@echo "Usage: make [command]"
	@echo ""
	@echo "Commands:"
	@echo "  setup     - åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰"
	@echo "  build     - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰"
	@echo "  up        - ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•"
	@echo "  down      - ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢"
	@echo "  logs      - ãƒ­ã‚°ã®è¡¨ç¤º"
	@echo "  clean     - ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
	@echo "  test      - ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"
	@echo "  dev       - é–‹ç™ºç’°å¢ƒã®èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰"

# åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup:
	@echo "ğŸš€ Setting up Shodo Ecosystem..."
	@echo "Creating necessary directories..."
	@mkdir -p models cache browser-data
	@echo "Creating environment file..."
	@cp -n .env.example .env || true
	@echo "âœ… Setup complete!"

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build --parallel

# ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•
up:
	@echo "ğŸš€ Starting services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo ""
	@echo "Access points:"
	@echo "  Frontend:    http://localhost:3000"
	@echo "  Backend API: http://localhost:8000"
	@echo "  vLLM Server: http://localhost:8001"
	@echo "  Database:    localhost:5432"
	@echo "  Redis:       localhost:6379"

# é–‹ç™ºç’°å¢ƒã®èµ·å‹•ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰
dev:
	@echo "ğŸš€ Starting development environment..."
	docker-compose up

# ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢
down:
	@echo "ğŸ›‘ Stopping services..."
	docker-compose down

# ãƒ­ã‚°ã®è¡¨ç¤º
logs:
	docker-compose logs -f

# ç‰¹å®šã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ­ã‚°
logs-backend:
	docker-compose logs -f backend

logs-frontend:
	docker-compose logs -f frontend

logs-vllm:
	docker-compose logs -f vllm

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down -v
	rm -rf node_modules
	rm -rf frontend/node_modules
	rm -rf backend/__pycache__
	rm -rf .pytest_cache
	@echo "âœ… Cleanup complete!"

# ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
test:
	@echo "ğŸ§ª Running tests..."
	@echo "Backend tests..."
	docker-compose run --rm backend pytest
	@echo "Frontend tests..."
	docker-compose run --rm frontend npm test

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
migrate:
	docker-compose exec backend python -m alembic upgrade head

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ¼ãƒ‰
seed:
	docker-compose exec backend python scripts/seed_data.py

# æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰
build-prod:
	@echo "ğŸ“¦ Building for production..."
	docker-compose -f docker-compose.prod.yml build

# æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤
deploy:
	@echo "ğŸš€ Deploying to production..."
	docker-compose -f docker-compose.prod.yml up -d

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
health:
	@echo "ğŸ¥ Health check..."
	@curl -s http://localhost:8000/health | jq '.' || echo "Backend not responding"
	@curl -s http://localhost:8001/health | jq '.' || echo "vLLM not responding"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
perf:
	@echo "âš¡ Performance test..."
	@ab -n 100 -c 10 http://localhost:8000/api/v1/nlp/analyze